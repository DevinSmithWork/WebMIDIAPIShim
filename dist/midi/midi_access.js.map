{"version":3,"sources":["../../src/midi/midi_access.js"],"names":["createMIDIAccess","dispatchEvent","closeAllMIDIInputs","getMIDIDeviceId","midiAccess","jazzInstance","midiInputs","midiOutputs","midiInputIds","midiOutputIds","listeners","MIDIAccess","sysexEnabled","inputs","outputs","type","listener","useCapture","has","add","delete","Promise","resolve","reject","undefined","browser","message","instance","createMIDIPorts","setupListeners","callback","MidiInList","MidiOutList","numInputs","length","numOutputs","loopCreateMIDIPort","index","max","list","name","createMIDIPort","port","info","Support","MidiInInfo","set","id","MidiOutInfo","getPortByName","ports","values","i","OnDisconnectMidiIn","state","close","_jazzInstance","inputInUse","OnDisconnectMidiOut","outputInUse","OnConnectMidiIn","OnConnectMidiOut","evt","onstatechange","forEach","input","MidiInClose","get"],"mappings":"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","file":"midi_access.js","sourcesContent":["/*\n  Creates a MIDIAccess instance:\n  - Creates MIDIInput and MIDIOutput instances for the initially connected MIDI devices.\n  - Keeps track of newly connected devices and creates the necessary instances of MIDIInput and MIDIOutput.\n  - Keeps track of disconnected devices and removes them from the inputs and/or outputs map.\n  - Creates a unique id for every device and stores these ids by the name of the device:\n    so when a device gets disconnected and reconnected again, it will still have the same id. This\n    is in line with the behavior of the native MIDIAccess object.\n\n*/\n\nimport MIDIInput from './midi_input';\nimport MIDIOutput from './midi_output';\nimport MIDIConnectionEvent from './midiconnection_event';\nimport { createJazzInstance, getJazzInstance } from '../util/jazz_instance';\nimport { getDevice, generateUUID } from '../util/util';\nimport Store from '../util/store';\n\nlet midiAccess;\nlet jazzInstance;\nconst midiInputs = new Store();\nconst midiOutputs = new Store();\nconst midiInputIds = new Store();\nconst midiOutputIds = new Store();\nconst listeners = new Store();\n\nclass MIDIAccess {\n    constructor(midiInputs, midiOutputs) {\n        this.sysexEnabled = true;\n        this.inputs = midiInputs;\n        this.outputs = midiOutputs;\n    }\n\n    addEventListener(type, listener, useCapture) {\n        if (type !== 'statechange') {\n            return;\n        }\n        if (listeners.has(listener) === false) {\n            listeners.add(listener);\n        }\n    }\n\n    removeEventListener(type, listener, useCapture) {\n        if (type !== 'statechange') {\n            return;\n        }\n        if (listeners.has(listener) === true) {\n            listeners.delete(listener);\n        }\n    }\n}\n\n\nexport function createMIDIAccess() {\n    return new Promise(((resolve, reject) => {\n        if (midiAccess !== undefined) {\n            resolve(midiAccess);\n            return;\n        }\n\n        if (getDevice().browser === 'ie9') {\n            reject({ message: 'WebMIDIAPIShim supports Internet Explorer 10 and above.' });\n            return;\n        }\n\n        createJazzInstance((instance) => {\n            if (instance === undefined) {\n                reject({ message: 'No access to MIDI devices: browser does not support the WebMIDI API and the Jazz plugin is not installed.' });\n                return;\n            }\n\n            jazzInstance = instance;\n\n            createMIDIPorts(() => {\n                setupListeners();\n                midiAccess = new MIDIAccess(midiInputs, midiOutputs);\n                resolve(midiAccess);\n            });\n        });\n    }));\n}\n\n\n// create MIDIInput and MIDIOutput instances for all initially connected MIDI devices\nfunction createMIDIPorts(callback) {\n    const inputs = jazzInstance.MidiInList();\n    const outputs = jazzInstance.MidiOutList();\n    const numInputs = inputs.length;\n    const numOutputs = outputs.length;\n\n    loopCreateMIDIPort(0, numInputs, 'input', inputs, () => {\n        loopCreateMIDIPort(0, numOutputs, 'output', outputs, callback);\n    });\n}\n\n\nfunction loopCreateMIDIPort(index, max, type, list, callback) {\n    if (index < max) {\n        const name = list[index++];\n        createMIDIPort(type, name, () => {\n            loopCreateMIDIPort(index, max, type, list, callback);\n        });\n    } else {\n        callback();\n    }\n}\n\n\nfunction createMIDIPort(type, name, callback) {\n    getJazzInstance(type, (instance) => {\n        let port;\n        let info = [name, '', ''];\n        if (type === 'input') {\n            if (instance.Support('MidiInInfo')) {\n                info = instance.MidiInInfo(name);\n            }\n            port = new MIDIInput(info, instance);\n            midiInputs.set(port.id, port);\n        } else if (type === 'output') {\n            if (instance.Support('MidiOutInfo')) {\n                info = instance.MidiOutInfo(name);\n            }\n            port = new MIDIOutput(info, instance);\n            midiOutputs.set(port.id, port);\n        }\n        callback(port);\n    });\n}\n\n\n// lookup function: Jazz gives us the name of the connected/disconnected MIDI devices but we have stored them by id\nfunction getPortByName(ports, name) {\n    let port;\n    const values = ports.values();\n    for (let i = 0; i < values.length; i += 1) {\n        port = values[i];\n        if (port.name === name) {\n            break;\n        }\n    }\n    return port;\n}\n\n\n// keep track of connected/disconnected MIDI devices\nfunction setupListeners() {\n    jazzInstance.OnDisconnectMidiIn((name) => {\n        const port = getPortByName(midiInputs, name);\n        if (port !== undefined) {\n            port.state = 'disconnected';\n            port.close();\n            port._jazzInstance.inputInUse = false;\n            midiInputs.delete(port.id);\n            dispatchEvent(port);\n        }\n    });\n\n    jazzInstance.OnDisconnectMidiOut((name) => {\n        const port = getPortByName(midiOutputs, name);\n        if (port !== undefined) {\n            port.state = 'disconnected';\n            port.close();\n            port._jazzInstance.outputInUse = false;\n            midiOutputs.delete(port.id);\n            dispatchEvent(port);\n        }\n    });\n\n    jazzInstance.OnConnectMidiIn((name) => {\n        createMIDIPort('input', name, (port) => {\n            dispatchEvent(port);\n        });\n    });\n\n    jazzInstance.OnConnectMidiOut((name) => {\n        createMIDIPort('output', name, (port) => {\n            dispatchEvent(port);\n        });\n    });\n}\n\n\n// when a device gets connected/disconnected both the port and MIDIAccess dispatch a MIDIConnectionEvent\n// therefor we call the ports dispatchEvent function here as well\nexport function dispatchEvent(port) {\n    port.dispatchEvent(new MIDIConnectionEvent(port, port));\n\n    const evt = new MIDIConnectionEvent(midiAccess, port);\n\n    if (typeof midiAccess.onstatechange === 'function') {\n        midiAccess.onstatechange(evt);\n    }\n    listeners.forEach(listener => listener(evt));\n}\n\n\nexport function closeAllMIDIInputs() {\n    midiInputs.forEach((input) => {\n        // input.close();\n        input._jazzInstance.MidiInClose();\n    });\n}\n\n\n// check if we have already created a unique id for this device, if so: reuse it, if not: create a new id and store it\nexport function getMIDIDeviceId(name, type) {\n    let id;\n    if (type === 'input') {\n        id = midiInputIds.get(name);\n        if (id === undefined) {\n            id = generateUUID();\n            midiInputIds.set(name, id);\n        }\n    } else if (type === 'output') {\n        id = midiOutputIds.get(name);\n        if (id === undefined) {\n            id = generateUUID();\n            midiOutputIds.set(name, id);\n        }\n    }\n    return id;\n}\n\n"]}